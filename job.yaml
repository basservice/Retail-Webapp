- project:
    name: PCF_DEMO_TEST
    jobs:
        - 'pcfbuild'
        - 'pcfcodeanalysis'
        - 'pcfdeployment'
- job-template:
    name: 01Pcf_Build
    id: pcfbuild
    project-type: maven
    maven:
      root-pom: pom.xml
      goals: clean install
      post-step-run-condition: SUCCESS
    defaults: global
    description: 'Build and deploy artifact to pcf'
    block-downstream: true
    block-upstream: true
    concurrent: false
    node: master
    properties:
       - throttle:
          max-per-node: 1
          max-total: 1
          option: project
    scm:
       - git:
          url: https://github.com/iamgituser/Retail-Webapp.git
          branches:
            - '*/master'
          git-config-name: iamgituser
          git-config-email: koffeewitharun@gmail.com
          force-polling-using-workspace: true
          extensions:
            per-build-tag: false
    triggers:
       - pollscm:
          cron: "* * * * *"
          ignore-post-commit-hooks: True
    publishers:
        - clone-workspace:
            criteria: "any"
            archive-method: "zip"
            override-default-excludes: false
        - trigger:
            project: 02Pcf_CodeAnalysis
- job-template:
    name: 02Pcf_CodeAnalysis
    id: pcfcodeanalysis
    scm:
        - workspace:
            parent-job: 01Pcf_Build
            criteria: Any
    builders:
      - shell: "mvn deploy:deploy-file -DgroupId=com.cts.sample -DartifactId=retainone -Dversion=0.0.1-SNAPSHOT -DgeneratePom=true -Dpackaging=war -DrepositoryId=nexus
-Durl=http://54.160.192.63:8082/nexus/content/repositories/testrepo/ -Dfile=target/retailone.war"
      - shell: "export user=user7\nexport pname=user7project\nexport sonarhost=54.159.162.77:9000\ncurl -X POST -v -u admin:admin \"http://$sonarhost/api/users/create?l
ogin=$user&password=$user&password_confirmation=$user&name=$user&email=$user@ctsemail.com\"\ncurl -u admin:admin -X POST \"http://$sonarhost/api/projects/create?key=$pn
ame&name=$pname\"\ncurl -v -u admin:admin -X POST \"http://$sonarhost/api/permissions/add_user?projectKey=$pname&permission=user&login=$user\"\ncurl -v -u admin:admin -
X POST \"http://$sonarhost/api/permissions/add_user?projectKey=$pname&permission=user&login=admin\""
      - sonar:
          sonar-name: SonarQube
          properties: "# required metadata\nsonar.projectKey=user7project\nsonar.projectName=user7project\nsonar.projectVersion=1.0\n\n# path to source directories (req
uired)\nsonar.sources=src\n\n# path to test source directories (optional)\n\n#sonar.tests=testDir1,testDir2\n\n# path to project binaries (optional), for example direct
ory of Java bytecode\n\n#sonar.binaries=binDir\n\n# optional comma-separated list of paths to libraries. Only path to JAR file and path to directory of classes are supp
orted.\n\n#sonar.libraries=path/to/library.jar,path/to/classes/dir\n\n# Uncomment this line to analyse a project which is not a java project.\n\n# The value of the prop
erty must be the key of the language.\n\n#sonar.language=cobol\n\n# Additional parameters\nsonar.my.property=value\n"
          java-opts: "-Xmx512m -XX:MaxPermSize=128m"
          jdk: JDK1.8
    publishers:
        - trigger:
            project: 03Pcf_Deployment
- job-template:
    name: 03Pcf_Deployment
    id: pcfdeployment
    description: 'Build and deploy artifact to pcf'
    scm:
        - workspace:
            parent-job: 01Pcf_Build
            criteria: Any
    wrappers:
        - inject-passwords:
            global: true
            mask-password-params: true
            job-passwords:
                - name: pcfusername
                  password: Sudhir.Govindaraju@cognizant.com
                - name: pcfpassword
                  password: password@123
    builders:
      - shell: "cf login -a https://api.system.cogpcfdevops.com --skip-ssl-validation -u $pcfusername -p $pcfpassword -o \"Raj PCF\" -s Development\ncf push -f manifest -dev.yml"
- docker_image:
    name: devopsbasservice/basejenkins_maven_git_java
